<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="<%= botClient.user.displayAvatarURL({ size: 128 }) %>">
    <link rel="stylesheet" href="/public/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link rel="stylesheet" href="/index.css">
    <title>Configuracoes | <%= guild.name %></title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
  </head>
  <body>
    <%- include('header'); -%>

    <section class="dashboard-page settings-page">
      <div class="form-holder">
        <div class="form-content">
          <div class="form-items">
            <div class="settings-header">
              <h3>Configuracoes do servidor</h3>
              <p>Edite as configuracoes do <%= botClient.user.username %> em <b><%= guild.name %></b>.</p>
            </div>

            <form method="POST" class="settings-form">
              <div class="settings-group">
                <h5>Prefixo</h5>
                <p class="form-helper">Prefixo usado para comandos de texto.</p>
                <input type="text" class="form-control" name="prefix" value="<%= botClient.settings.get(guild.id, 'prefix') %>" placeholder="Ex.: k!">
              </div>

              <div class="settings-group">
                <h5>Reproducao automatica padrao</h5>
                <p class="form-helper">Ativa autoplay por padrao quando a fila iniciar.</p>
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    name="defaultautoplay"
                    id="defaultautoplay"
                    style="zoom: 1.4; margin-left: 0; margin-right: 10px;"
                    <%= botClient.settings.get(guild.id, 'defaultautoplay') ? 'checked' : '' %>
                  >
                  <label class="form-check-label" for="defaultautoplay">
                    <%= botClient.settings.get(guild.id, 'defaultautoplay') ? 'Ativado' : 'Desativado' %> (atualiza ao salvar)
                  </label>
                </div>
              </div>

              <div class="settings-group">
                <h5>Volume padrao</h5>
                <p class="form-helper">Volume aplicado quando uma nova fila e criada.</p>
                <input oninput="this.nextElementSibling.value = this.value" type="range" class="form-range" min="1" max="150" step="1" value="<%= botClient.settings.get(guild.id, 'defaultvolume') %>" name="defaultvolume" id="defaultvolume">
                <p class="slider-value">Volume atual: <output><%= botClient.settings.get(guild.id, 'defaultvolume') %></output>%</p>
              </div>

              <div class="settings-group">
                <h5>Cargos DJ</h5>
                <p class="form-helper">Usuarios com estes cargos podem usar comandos de controle de musica/fila.</p>
                <select class="form-control selectpicker" multiple data-width="100%" data-live-search="true" aria-label="DJ Roles" name="djroles">
                  <% guild.roles.cache.filter(role => !role.managed).sort((a, b) => b.rawPosition - a.rawPosition).forEach((role) => { %>
                    <option value="<%= role.id %>" <%= botClient.settings.get(guild.id, 'djroles').includes(role.id) ? 'selected' : '' %>>
                      @<%= role.name %>
                    </option>
                  <% }) %>
                </select>
              </div>

              <div class="settings-group">
                <h5>Canais liberados para comandos</h5>
                <p class="form-helper">Se definido, o bot responde comandos apenas nestes canais.</p>
                <select class="form-control selectpicker" multiple data-width="100%" data-height="100%" data-live-search="true" aria-label="Bot Channels" name="botchannel">
                  <% guild.channels.cache
                      .filter((channel) => {
                        const isTextBased = typeof channel.isTextBased === 'function' && channel.isTextBased();
                        const isThread = typeof channel.isThread === 'function' && channel.isThread();
                        if (!isTextBased || isThread) return false;
                        const perms = channel.permissionsFor(botClient.user);
                        return Boolean(perms && perms.has(['ViewChannel', 'SendMessages', 'EmbedLinks']));
                      })
                      .sort((a, b) => a.rawPosition - b.rawPosition)
                      .forEach((channel) => { %>
                    <option value="<%= channel.id %>" <%= botClient.settings.get(guild.id, 'botchannel').includes(channel.id) ? 'selected' : '' %>>
                      #<%= channel.name %>
                    </option>
                  <% }) %>
                </select>
              </div>

              <div class="settings-group">
                <h5>Filtros padrao</h5>
                <p class="form-helper">Filtros que o bot aplica antes de iniciar a reproducao.</p>
                <select class="form-control selectpicker" multiple data-width="100%" data-height="100%" data-live-search="true" aria-label="Default Filters" name="defaultfilters">
                  <% Object.keys(BotFilters).forEach((filter) => { %>
                    <option value="<%= filter %>" <%= botClient.settings.get(guild.id, 'defaultfilters').includes(filter) ? 'selected' : '' %>>
                      <%= filter %>
                    </option>
                  <% }) %>
                </select>
              </div>

              <div class="settings-actions">
                <a href="/dashboard" class="btn-modern btn-modern-secondary">Voltar</a>
                <button type="submit" class="btn-modern btn-modern-primary">
                  Salvar Configuracoes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="hero-card settings-queue-card">
        <h5 style="margin-top:0;">Fila ao vivo</h5>
        <p class="subtext" style="text-align:left; margin: 8px 0 14px;">
          Musicas na fila: <b><%= botClient.distube.getQueue(guild.id) && botClient.distube.getQueue(guild.id).songs ? botClient.distube.getQueue(guild.id).songs.length : 0 %></b>
        </p>
        <a href="/queue/<%= guild.id %>" class="btn-modern btn-modern-secondary">Abrir player/fila</a>
      </div>
    </section>

    <%- include('footer'); -%>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
  </body>
</html>
